<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Group Availability Scheduler</title>
  <style>
    /* ...[same styling as before, unchanged]... */
  </style>
</head>
<body>
  <h1>Group Availability Scheduler</h1>
  <form id="availability-form">
    <input type="text" id="name" placeholder="Enter your name" required />
    <div id="timeslots-container"></div>
    <button type="submit">Submit Availability</button>
  </form>

  <div id="results">
    <h2>Loading availability...</h2>
  </div>

  <div class="admin">
    <button id="reset-btn">Reset All Availability (Luke Only)</button>
  </div>

  <script>
    const timeslotsContainer = document.getElementById('timeslots-container');
    const startDate = new Date(2025, 6, 9); // July 9, 2025
    const endDate = new Date(2025, 6, 27); // July 27, 2025
    const twoHourBlocks = [
      '10 AM - 12 PM',
      '12 PM - 2 PM',
      '2 PM - 4 PM',
      '4 PM - 6 PM',
    ];

    function formatDate(d) {
      return d.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'short' });
    }

    // Create time blocks
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
      const dayBlock = document.createElement('div');
      dayBlock.className = 'day-block';

      const dayTitle = document.createElement('div');
      dayTitle.className = 'day-title';
      dayTitle.textContent = formatDate(new Date(d));
      dayBlock.appendChild(dayTitle);

      const timeBlocksDiv = document.createElement('div');
      timeBlocksDiv.className = 'time-blocks';

      twoHourBlocks.forEach(block => {
        const slotValue = `${formatDate(new Date(d))} ${block}`;

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = slotValue;
        checkbox.name = 'availability';
        checkbox.value = slotValue;

        const label = document.createElement('label');
        label.className = 'time-label';
        label.htmlFor = slotValue;
        label.textContent = block;

        timeBlocksDiv.appendChild(checkbox);
        timeBlocksDiv.appendChild(label);
      });

      dayBlock.appendChild(timeBlocksDiv);
      timeslotsContainer.appendChild(dayBlock);
    }

    const form = document.getElementById('availability-form');
    const resultsDiv = document.getElementById('results');
    const resetBtn = document.getElementById('reset-btn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const checkedBoxes = [...document.querySelectorAll('input[name="availability"]:checked')];
      if (!name) return alert('Please enter your name.');
      if (checkedBoxes.length === 0) return alert('Please select at least one time block.');

      const availability = checkedBoxes.map(cb => cb.value);
      try {
        const res = await fetch('/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, availability }),
        });
        const data = await res.json();
        alert(data.message);
        form.reset();
        loadResults();
      } catch {
        alert('Error submitting availability! Please contact Luke');
      }
    });

    async function loadResults() {
      try {
        const res = await fetch('/results');
        const data = await res.json();

        if (data.bestTimes.length === 0) {
          resultsDiv.innerHTML = '<h2>No availability submitted yet.</h2>';
          return;
        }

        // Parse and sort bestTimes by number
        const bestSlotCounts = data.bestTimes.map(label => {
          const match = label.match(/\((\d+) people\)$/);
          const count = match ? parseInt(match[1], 10) : 0;
          return { label, count };
        });

        bestSlotCounts.sort((a, b) => b.count - a.count);
        const top5 = bestSlotCounts.slice(0, 5);

        const bestTimesHtml = top5.map(t => `<li>${t.label}</li>`).join('');

        const allAvailHtml = data.availabilities.map(u =>
          `<li><b>${u.name}:</b> ${u.availability.join(', ')}</li>`
        ).join('');

        resultsDiv.innerHTML = `
          <h2>Top 5 Best Times to Meet:</h2>
          <ul class="best-times">${bestTimesHtml}</ul>
          <h2>All Submissions:</h2>
          <ul>${allAvailHtml}</ul>
        `;
      } catch {
        resultsDiv.innerHTML = '<h2>Error loading availability.</h2>';
      }
    }

    loadResults();

    resetBtn.addEventListener('click', async () => {
      const password = prompt('Enter admin password to reset all availability:');
      if (!password) return;
      try {
        const res = await fetch('/reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password }),
        });
        const data = await res.json();
        alert(data.message || data.error);
        if (!data.error) loadResults();
      } catch {
        alert('Error resetting availability.');
      }
    });
  </script>
</body>
</html>
